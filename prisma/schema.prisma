generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String             @id @default(cuid())
  email               String             @unique
  name                String?
  avatar              String?
  password            String?            // Para autenticación con email/password
  isVerified          Boolean            @default(false)
  verificationToken   String?            // Token para verificación de email
  verificationExpires DateTime?          // Expiración del token
  role                UserRole           @default(USER)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  assessments         Assessment[]
  healthProfile       HealthProfile?
  payments            Payment[]
  professional        Professional?
  downloadedResources ResourceDownload[]
  sessionsAsClient    Session[]          @relation("ClientSessions")

  @@map("users")
}

model Professional {
  id               String                        @id @default(cuid())
  userId           String                        @unique
  type             ProfessionalType
  description      String?
  experience       Int?
  rating           Float?                        @default(0)
  hourlyRate       Float?
  verified         Boolean                       @default(false)
  verifiedAt       DateTime?
  availability     Json?
  createdAt        DateTime                      @default(now())
  updatedAt        DateTime                      @updatedAt
  specialties      ProfessionalSpecialty[]
  user             User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions         Session[]
  sessionTemplates ProfessionalSessionTemplate[]

  @@map("professionals")
}

model HealthProfile {
  id           String        @id @default(cuid())
  userId       String        @unique
  diabetesType DiabetesType?
  diagnosedAt  DateTime?
  weight       Float?
  height       Float?
  age          Int?
  goals        String
  medications  String
  allergies    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("health_profiles")
}

model Resource {
  id           String             @id @default(cuid())
  title        String
  description  String?
  type         ResourceType
  fileUrl      String?
  thumbnailUrl String?
  price        Float?             @default(0)
  tags         String
  requiresAuth Boolean            @default(true)
  premiumOnly  Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  downloads    ResourceDownload[]

  @@map("resources")
}

model ResourceDownload {
  id           String   @id @default(cuid())
  userId       String
  resourceId   String
  downloadedAt DateTime @default(now())
  resource     Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@map("resource_downloads")
}

// Plantillas de sesiones que pueden ofrecer los profesionales
model SessionTemplate {
  id             String                        @id @default(cuid())
  title          String
  description    String?
  basePrice      Float
  durationId     String
  specialtyId    String?
  category       SessionCategory               @default(CONSULTATION)
  modality       SessionModality               @default(ONLINE)
  requiresPrereq Boolean                       @default(false)
  prerequisiteId String?
  isActive       Boolean                       @default(true)
  createdAt      DateTime                      @default(now())
  updatedAt      DateTime                      @updatedAt
  duration       SessionDuration               @relation(fields: [durationId], references: [id])
  specialty      SessionSpecialty?             @relation(fields: [specialtyId], references: [id])
  prerequisite   SessionTemplate?              @relation("SessionPrerequisites", fields: [prerequisiteId], references: [id])
  prerequisites  SessionTemplate[]             @relation("SessionPrerequisites")
  professionals  ProfessionalSessionTemplate[]
  sessions       Session[]

  @@map("session_templates")
}

// Relación many-to-many entre profesionales y plantillas de sesiones
model ProfessionalSessionTemplate {
  id                String          @id @default(cuid())
  professionalId    String
  sessionTemplateId String
  customPrice       Float? // Precio personalizado del profesional (opcional)
  isEnabled         Boolean         @default(true)
  createdAt         DateTime        @default(now())
  professional      Professional    @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  sessionTemplate   SessionTemplate @relation(fields: [sessionTemplateId], references: [id], onDelete: Cascade)

  @@unique([professionalId, sessionTemplateId])
  @@map("professional_session_templates")
}

// Duraciones de sesiones configurables
model SessionDuration {
  id        String            @id @default(cuid())
  name      String // "30 minutos", "1 hora", "2 horas"
  minutes   Int // 30, 60, 120
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  templates SessionTemplate[]

  @@unique([minutes])
  @@map("session_durations")
}

// Especialidades de sesiones (diferentes a las de profesionales)
model SessionSpecialty {
  id          String            @id @default(cuid())
  name        String // "Control glucémico", "Nutrición", "Apoyo psicológico"
  description String?
  color       String? // Para UI (ej: "#3b82f6")
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  templates   SessionTemplate[]

  @@map("session_specialties")
}

// Sesiones reales/reservas (instancias de las plantillas)
model Session {
  id                String          @id @default(cuid())
  clientId          String
  professionalId    String
  sessionTemplateId String
  title             String // Copiado de la plantilla al crear
  description       String? // Copiado de la plantilla al crear
  scheduledAt       DateTime
  duration          Int // Copiado de la plantilla al crear
  status            SessionStatus   @default(SCHEDULED)
  finalPrice        Float // Precio final aplicado
  meetingUrl        String?
  recordingUrl      String?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  payment           Payment?
  client            User            @relation("ClientSessions", fields: [clientId], references: [id], onDelete: Cascade)
  professional      Professional    @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  sessionTemplate   SessionTemplate @relation(fields: [sessionTemplateId], references: [id])

  @@map("sessions")
}

model Payment {
  id                 String        @id @default(cuid())
  userId             String
  sessionId          String?       @unique
  amount             Float
  currency           String        @default("EUR")
  status             PaymentStatus @default(PENDING)
  stripePaymentId    String?       @unique
  professionalAmount Float?
  platformAmount     Float?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  session            Session?      @relation(fields: [sessionId], references: [id])
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Assessment {
  id        String   @id @default(cuid())
  userId    String?
  responses Json
  results   Json
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

model ProfessionalSpecialty {
  id             String       @id @default(cuid())
  professionalId String
  diabetesType   DiabetesType
  description    String?
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, diabetesType])
  @@map("professional_specialties")
}

model Newsletter {
  id          String           @id @default(cuid())
  email       String           @unique
  source      NewsletterSource @default(MAINTENANCE_PAGE)
  ipAddress   String?
  userAgent   String?
  isActive    Boolean          @default(true)
  isVerified  Boolean          @default(false)
  verifyToken String?          @unique
  spamScore   Float            @default(0)
  isBlocked   Boolean          @default(false)
  blockReason String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  verifiedAt  DateTime?
  interests   String[]

  @@map("newsletter_subscriptions")
}

enum UserRole {
  VISITOR
  USER
  PROFESSIONAL
  ADMIN
}

enum DiabetesType {
  TYPE_1
  TYPE_2
  GESTATIONAL
  PREDIABETES
  INFANTIL
}

enum ProfessionalType {
  DIETISTA
  NUTRICIONISTA
  EDUCADOR
  ENTRENADOR
  PSICOLOGO
  MEDICO
}

enum ResourceType {
  GUIA
  LIBRO
  MENU
  VIDEO
  AUDIO
  DOCUMENTO
}

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum SessionCategory {
  CONSULTATION // Consulta general
  INITIAL // Consulta inicial
  FOLLOW_UP // Seguimiento
  EMERGENCY // Emergencia
  EDUCATION // Educación
  NUTRITION // Nutrición
  PSYCHOLOGY // Apoyo psicológico
  GROUP // Sesión grupal
}

enum SessionModality {
  ONLINE // Virtual
  IN_PERSON // Presencial
  HYBRID // Híbrida
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NewsletterSource {
  MAINTENANCE_PAGE
  LANDING_PAGE
  BLOG
  SOCIAL_MEDIA
  REFERRAL
}
